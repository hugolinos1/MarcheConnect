
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * MARCHÉCONNECT SECURITY RULES
     */

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // Accès autorisé si l'utilisateur est l'admin principal ou présent dans roles_admin
      return isSignedIn() && (
        request.auth.token.email == "hugues.rabier@gmail.com" ||
        exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid))
      );
    }

    // --- Collection Rules ---

    match /roles_admin/{adminId} {
      // Un utilisateur peut voir son propre statut d'admin, sinon il faut être admin
      allow get: if isSignedIn() && (request.auth.uid == adminId || isAdmin());
      // Seuls les admins confirmés peuvent lister et gérer tous les accès
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /market_configurations/{marketConfigId} {
      // Lecture publique pour l'affiche et l'année
      allow get, list: if true;
      // Modification réservée aux admins
      allow create, update, delete: if isAdmin();
    }

    match /pre_registrations/{preRegistrationId} {
      // Tout le monde peut créer une candidature (Form 1)
      allow create: if true;
      // Seuls les admins peuvent lister et gérer les candidatures
      allow get, list, update, delete: if isAdmin();
    }

    match /exhibitor_details/{exhibitorDetailId} {
      // Les exposants peuvent créer/modifier via leur lien (Form 2)
      allow create, update: if true;
      // Consultation réservée aux admins
      allow get, list, delete: if isAdmin();
    }
  }
}
